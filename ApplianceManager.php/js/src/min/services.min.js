var currentService,currentServiceGroup,serviceModified,nodesLoaded=!1,serviceNameFilterPrevVal="",serviceGroupNameFilterPrevVal="",frontEndEndPointFilterPrevVal="",backEndEndPointFilterPrevVal="",nodeNameFilterPrevVal="";function setServiceModified(a){(serviceModified=a)?setActionButtonEnabled("saveService",!0):setActionButtonEnabled("saveService",!1);""!=$("#additionalConfiguration").val()?$("#warnAdditionalConfig").show():$("#warnAdditionalConfig").hide()}
function populateNodeListFilter(a){defaultLabel="ZZOPEN echo Localization::getJSString(QUOTEservice.label.chooseNodeQUOTE)ZZCLOSE";$("#nodeNameFilter").append($("<option>",{value:"",text:defaultLabel}));$.each(a,function(a,b){$("#nodeNameFilter").append($("<option>",{value:b.nodeName,text:""!=b.nodeDescription?b.nodeDescription:b.nodeName}))});""!=nodeNameFilterPrevVal&&$("#nodeNameFilter option[value="+nodeNameFilterPrevVal+"]").prop("selected","selected")}
function startLoadNodes(){$.getJSON("nodes",populateNodeListFilter).error(displayErrorV2)}function startEditService(a){$.getJSON(a,editService).error(displayErrorV2)}function startPopulateGroups(){$.getJSON("groups/",populateGroups).error(displayErrorV2)}
function populateGroups(a){$.each(a,function(a,b){$("#groupName").append($("<option>",{value:b.groupName,text:""!=b.description?b.description:b.groupName}))});""!=currentServiceGroupName&&$("#groupName option[value="+currentServiceGroupName+"]").prop("selected","selected")}function updateService(a){saveOrUpdateService("PUT")}
function checkUserAuth(){document.getElementById("isUserAuthenticationEnabled").checked?($("#allowAnonymous").show(),$("#group").show(),$("#idForwarding").show(),$("#userQuota").show(),$("#loginForm").show(),document.getElementById("isAnonymousAllowed").checked?($("#isIdentityForwardingEnabled").prop("checked",!0),$("#isIdentityForwardingEnabled").prop("disabled",!0)):$("#isIdentityForwardingEnabled").prop("disabled",!1)):($("#loginForm").hide(),$("#allowAnonymous").hide(),$("#group").hide(),$("#idForwarding").hide(),
$("#userQuota").hide());setServiceModified(!0)}
function editService(a){$.get("resources/templates/serviceEdit.php",function(c){nodesLoaded=!1;currentService=a;currentServiceGroup=a.groupUri;currentServiceGroupName=a.groupName;cbIsUserAuthenticationEnabled=cbIsPublished="checked";cbIsHitLoggingEnabled=cbIsAnonymousAllowed="";cbOnAllNodes="checked";cbUserQuota=cbIdentFwd="";1==a.isUserQuotasEnabled&&(cbUserQuota="checked");1==a.isIdentityForwardingEnabled&&(cbIdentFwd="checked");0==a.isPublished&&(cbIsPublished="");0==a.isUserAuthenticationEnabled&&
(cbIsUserAuthenticationEnabled="");1==a.isHitLoggingEnabled&&(cbIsHitLoggingEnabled="checked");1==a.isAnonymousAllowed&&(cbIsAnonymousAllowed="checked");0==a.onAllNodes&&(cbOnAllNodes="");$("#content").html(c.replaceAll("{uri}",a.uri).replaceAll("{reqSec}",0==a.reqSec?"":a.reqSec).replaceAll("{reqDay}",0==a.reqDay?"":a.reqDay).replaceAll("{reqMonth}",0==a.reqMonth?"":a.reqMonth).replaceAll("{cbUserQuota}",cbUserQuota).replaceAll("{serviceName}",a.serviceName).replaceAll("{serviceNameInputType}","hidden").replaceAll("{cbIsPublished}",
cbIsPublished).replaceAll("{backEndEndPointValue}",a.backEndEndPoint).replaceAll("{frontEndEndPointValue}",a.frontEndEndPoint).replaceAll("{cbIsUserAuthenticationEnabled}",cbIsUserAuthenticationEnabled).replaceAll("{loginFormUri}",a.loginFormUri).replaceAll("{cbIsAnonymousAllowed}",cbIsAnonymousAllowed).replaceAll("{cbIdentFwd}",cbIdentFwd).replaceAll("{backEndUsername}",a.backEndUsername).replaceAll("{backEndPassword}",a.backEndPassword).replaceAll("{cbOnAllNodes}",cbOnAllNodes).replaceAll("{cbIsHitLoggingEnabled}",
cbIsHitLoggingEnabled).replaceAll("{additionalConfiguration}",null==a.additionalConfiguration?"":a.additionalConfiguration));$(function(){$("#tabs").tabs()});document.getElementById("isGlobalQuotasEnabled").checked=0!=a.isGlobalQuotasEnabled;setQuotasVisibility();setNodesVisiblility();startPopulateGroups();checkUserAuth();setServiceModified(!1);$("#mainForm").height($("#tabs").height()+10);$("#mainForm").click(function(){$("#mainForm").height($("#tabs").height()+10)})})}
function saveOrUpdateService(a){isUserAuthenticationEnabled="isUserAuthenticationEnabled=0";isHitLoggingEnabled="isHitLoggingEnabled=0";isUserQuotasEnabled="isUserQuotasEnabled=0";isGlobalQuotasEnabled="isGlobalQuotasEnabled=0";isIdentityForwardingEnabled="isIdentityForwardingEnabled=0";isAnonymousAllowed="isAnonymousAllowed=0";isPublished="isPublished=1";serviceName="serviceName="+encodeURIComponent(document.getElementById("serviceName").value);frontEndEndPoint="frontEndEndPoint="+encodeURIComponent(document.getElementById("frontEndEndPoint").value);
backEndEndPoint="backEndEndPoint="+encodeURIComponent(document.getElementById("backEndEndPoint").value);backEndUsername="backEndUsername="+encodeURIComponent(document.getElementById("backEndUsername").value);backEndPassword="backEndPassword="+encodeURIComponent(document.getElementById("backEndPassword").value);groupName="groupName="+encodeURIComponent(document.getElementById("groupName").value);additionalConfiguration="additionalConfiguration="+encodeURIComponent(document.getElementById("additionalConfiguration").value);
loginFormUri="loginFormUri="+encodeURIComponent(document.getElementById("loginFormUri").value);onAllNodes=document.getElementById("onAllNodes").checked?"onAllNodes=1":"onAllNodes=0";document.getElementById("isGlobalQuotasEnabled").checked&&(isGlobalQuotasEnabled="isGlobalQuotasEnabled=1",reqSec="reqSec="+document.getElementById("reqSec").value,reqDay="reqDay="+document.getElementById("reqDay").value,reqMonth="reqMonth="+document.getElementById("reqMonth").value);document.getElementById("isUserQuotasEnabled").checked&&
(isUserQuotasEnabled="isUserQuotasEnabled=1");document.getElementById("isPublished").checked||(isPublished="isPublished=0");document.getElementById("isIdentityForwardingEnabled").checked&&(isIdentityForwardingEnabled="isIdentityForwardingEnabled=1");document.getElementById("isUserAuthenticationEnabled").checked?isUserAuthenticationEnabled="isUserAuthenticationEnabled=1":(isUserQuotasEnabled="isUserQuotasEnabled=0",isIdentityForwardingEnabled="isIdentityForwardingEnabled=0");document.getElementById("isHitLoggingEnabled").checked&&
(isHitLoggingEnabled="isHitLoggingEnabled=1");document.getElementById("isAnonymousAllowed").checked&&(isAnonymousAllowed="isAnonymousAllowed=1");postData=isUserQuotasEnabled+"&"+isGlobalQuotasEnabled+"&"+isIdentityForwardingEnabled+"&"+isPublished+"&"+frontEndEndPoint+"&"+backEndEndPoint+"&"+backEndUsername+"&"+backEndPassword+"&"+groupName+"&"+isUserAuthenticationEnabled+"&"+isHitLoggingEnabled+"&"+onAllNodes+"&"+additionalConfiguration+"&"+isAnonymousAllowed+"&"+loginFormUri;document.getElementById("isGlobalQuotasEnabled").checked&&
(postData+="&"+reqSec+"&"+reqDay+"&"+reqMonth);"PUT"==a?businessUrl="services/"+encodeURIComponent(document.getElementById("serviceName").value):(businessUrl="services/",postData="serviceName="+encodeURIComponent(document.getElementById("serviceName").value)+"&"+postData);document.getElementById("onAllNodes").checked||(postData+="&noApply=");showWait();$.ajax({url:businessUrl,dataType:"json",type:a,data:postData,success:manageNodesList,error:displayErrorV2})}
function manageNodesList(){nodes=document.getElementById("serviceNodesList");if(document.getElementById("onAllNodes").checked)showServices();else{var a=[];for(i=selectedCount=0;i<nodes.options.length;i++)nodes.options[i].selected&&(a[selectedCount]=nodes.options[i].value,selectedCount++);$.ajax({url:"services/"+encodeURIComponent($("#serviceName").val())+"/nodes/",dataType:"json",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",type:"POST",success:showServices,error:displayErrorV2})}}
function saveNewService(){saveOrUpdateService("POST")}function setNodesVisiblility(){document.getElementById("onAllNodes").checked?$("#publishedOnNodes").hide():($("#publishedOnNodes").show(),nodesLoaded||$.getJSON("services/"+encodeURIComponent($("#serviceName").val())+"/nodes/?order=nodeName",displayServiceNodes).error(displayErrorV2))}
function setQuotasVisibility(){userQuotas=reqMonth=reqDay=reqSec="";null!=currentService?(null!=document.getElementById("isUserQuotasEnabled")&&(document.getElementById("isUserQuotasEnabled").checked?currentService.isUserQuotasEnabled=1:currentService.isUserQuotasEnabled=0),reqSec=currentService.reqSec,reqDay=currentService.reqDay,reqMonth=currentService.reqMonth,userQuotas=0!=currentService.isUserQuotasEnabled):null!=document.getElementById("isUserQuotasEnabled")&&(userQuotas=document.getElementById("isUserQuotasEnabled").checked);
gc=document.getElementById("isGlobalQuotasEnabled");gc.checked?($("#globalQuotasMonth").show(),$("#globalQuotasDay").show(),$("#globalQuotasSec").show()):($("#globalQuotasMonth").hide(),$("#globalQuotasDay").hide(),$("#globalQuotasSec").hide());q=document.getElementById("quotas");document.getElementById("isUserQuotasEnabled").checked=userQuotas;checkUserAuth();setServiceModified(serviceModified)}
function addService(){$.get("resources/templates/serviceAdd.php",function(a){nodesLoaded=!1;currentServiceGroupName=currentServiceGroup=currentService=null;$("#content").html(a.replaceAll("{uri}","").replaceAll("{reqSec}","").replaceAll("{reqDay}","").replaceAll("{reqMonth}","").replaceAll("{cbUserQuota}","").replaceAll("{serviceName}","").replaceAll("{serviceNameInputType}","text").replaceAll("{cbIsPublished}","checked").replaceAll("{backEndEndPointValue}","").replaceAll("{frontEndEndPointValue}",
"").replaceAll("{cbIsUserAuthenticationEnabled}","").replaceAll("{loginFormUri}","").replaceAll("{cbIsAnonymousAllowed}","").replaceAll("{cbIdentFwd}","").replaceAll("{backEndUsername}","").replaceAll("{backEndPassword}","").replaceAll("{cbOnAllNodes}","checked").replaceAll("{cbIsHitLoggingEnabled}","").replaceAll("{additionalConfiguration}",""));$(function(){$("#tabs").tabs()});startPopulateGroups();setQuotasVisibility();setNodesVisiblility();setServiceModified(!1);$("#mainForm").height($("#tabs").height()+
10);$("#mainForm").click(function(){$("#mainForm").height($("#tabs").height()+10)})})}function handelServiceFilterFormKeypress(a){if(13==a.keyCode)return showServices(),!1}
function displayServiceNodes(a){$("#serviceNodesList").find("option").remove().end();$.each(a,function(a,b){port="";1==b.node.isHTTPS?(nodePrefix="https://",443!=b.node.port&&(port=":"+b.node.port)):(nodePrefix="http://",80!=b.node.port&&(port=":"+b.node.port));optionText=b.node.nodeName+" ("+nodePrefix+b.node.serverFQDN+port+")";$("#serviceNodesList").append($("<option>",{value:b.node.nodeName,text:optionText}));"0"!=b.published&&$("#serviceNodesList option[value="+b.node.nodeName+"]").prop("selected",
"selected");nodesLoaded=!0})}
function displayServiceList(a){hideWait();$.get("resources/templates/serviceList.php",function(c){$("#content").html(c.replaceAll("{serviceList.length}",a.length).replaceAll("{serviceNameFilterPrevVal}",serviceNameFilterPrevVal).replaceAll("{serviceGroupNameFilterPrevVal}",serviceGroupNameFilterPrevVal).replaceAll("{frontEndEndPointFilterPrevVal}",frontEndEndPointFilterPrevVal).replaceAll("{backEndEndPointFilterPrevVal}",backEndEndPointFilterPrevVal));table=document.getElementById("data");rowPattern=
document.getElementById("rowTpl");table.removeChild(rowPattern);for(i=0;i<a.length;i++)cbPublishedCheck=1==a[i].isPublished?"checked":"",newRow=rowPattern.cloneNode(!0),newRow.removeAttribute("id"),newRow.removeAttribute("style"),newRow.className=newRow.className+" tabular_table_body"+i%2,newRow.innerHTML=newRow.innerHTML.replaceAll("{serviceList[i].serviceName}",a[i].serviceName).replaceAll("{i}",i).replaceAll("{servicelist[i].cbpublishedcheck}",cbPublishedCheck).replaceAll("{serviceList[i].groupName}",
a[i].groupName).replaceAll("{serviceList[i].frontEndEndPoint}",a[i].frontEndEndPoint).replaceAll("{serviceList[i].backEndEndPoint}",a[i].backEndEndPoint).replaceAll("{serviceList[i].uri}",a[i].uri),table.appendChild(newRow),edit=document.getElementById("btnEdit"),del=document.getElementById("btnDelete"),publish=document.getElementById("btnPublish"),unpublish=document.getElementById("btnUnpublish"),a[i].serviceName.startsWith("ApplianceManagerAdmin")?del.remove():del.removeAttribute("id"),edit.removeAttribute("id"),
1==a[i].isPublished?(publish.remove(),unpublish.removeAttribute("id")):(unpublish.remove(),publish.removeAttribute("id"));setServiceModified(!1);startLoadNodes()})}function deleteService(a,c){confirm("ZZOPEN echo Localization::getJSString(QUOTEservice.delete.confirmQUOTE)ZZCLOSE "+c+"?")&&(showWait(),$.ajax({url:a,dataType:"json",type:"DELETE",success:showServices,error:displayErrorV2}))}
function resetServiceFilter(){$("#serviceNameFilter").val("");$("#serviceGroupNameFilter").val("");$("#frontEndEndPointFilter").val("");$("#backEndEndPointFilter").val("");$('#nodeNameFilter option[value=""]').prop("selected","selected");showServices()}
function showServices(){prms="order=serviceName";prms=prms+"&serviceNameFilter="+encodeURIComponent(getFilterValue("serviceNameFilter"));prms=prms+"&groupNameFilter="+encodeURIComponent(getFilterValue("serviceGroupNameFilter"));prms=prms+"&frontEndEndPointFilter="+encodeURIComponent(getFilterValue("frontEndEndPointFilter"));prms=prms+"&backEndEndPointFilter="+encodeURIComponent(getFilterValue("backEndEndPointFilter"));prms=prms+"&nodeNameFilter="+encodeURIComponent(getFilterValue("nodeNameFilter"));
$.ajax({url:"./services/",dataType:"json",type:"GET",data:prms,success:displayServiceList,error:displayErrorV2})}function publishService(a,c){showWait();$.ajax({url:a,dataType:"json",type:"PUT",data:"isPublished="+c,success:showServices,error:displayErrorV2})}$(function(){$("#listService").click(resetServiceFilter);$("#addService").click(addService)});
